<!DOCTYPE html>

<html lang="zh-tw">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>
        BrewPiLess 設定!
    </title>
    <meta name="apple-mobile-web-app-title" content="BrewPi Setup">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script>
function invoke(arg) {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (xhttp.readyState == 4) {
            if (xhttp.status == 200) {
                arg.success(xhttp.responseText);
            } else {
                xhttp.onerror(xhttp.status);
            }
        }
    };
    xhttp.ontimeout = function() {
            if (typeof arg["timeout"] != "undefined")
                arg.timeout();
            else
                xhttp.onerror(-1);
        },
        xhttp.onerror = function(a) {
            if (typeof arg["fail"] != "undefined")
                arg.fail(a);
        };

    xhttp.open(arg.m, arg.url, true);
    if (typeof arg["data"] != "undefined") {
        xhttp.setRequestHeader("Content-Type", (typeof arg["mime"] != "undefined") ? arg["mime"] : "application/x-www-form-urlencoded");
        xhttp.send(arg.data);
    } else
        xhttp.send();
}

var BWF = {
    BrewProfile: "/brewing.json",
    process: function(msg) {
        if (this.raw != null) {
            this.raw(msg);
            return;
        }
        //console.log("rcv:" + msg);
        eval("m={" + msg + "}");
        //	console.log("json:"+m);
        for (var key in m) {
            if (typeof this.handlers[key] != "undefined") {
                this.handlers[key](m[key]);
            }
        }
    },
    on: function(lb, handler) {
        this.handlers[lb] = handler;
    },
    send: function(data) {
        if (this.ws.readyState == 1) this.ws.send(data);
    },
    reconnecting: false,
    connect: function() {
        var me = this;
        if (typeof WebSocket !== "undefined") {
            var ws = new WebSocket('ws://' + document.location.host + '/ws');
            me.ws = ws;
            ws.onopen = function() {
                console.log("Connected");
                me.onconnect();
            };

            ws.onclose = function() {
                if (me.reconnecting) return;
                console.log("WS close");
                me.error(-2);
                if (me.auto) setTimeout(function() { me.reconnect(); }, 5000);
            };

            /*ws.onerror = function() {
                console.log("ws error");
            };*/

            ws.onmessage = function(e) {
                me.process(e.data);
            };
        } else {
            //console.log("not support WebSocket");
            alert("Error! WebSocket Not Supported!");
        }
    },
    reconnect: function(forced) {
        forced = (typeof forced == "undefined") ? false : true;
        var me = this;
        if (me.reconnecting) return;
        if (!forced && me.ws.readyState == 1) return;
        console.log("reconnect forced:" + forced + " state:" + me.ws.readyState);
        me.reconnecting = true;
        me.ws.close();
        // this might triger onerror, and result in "reconnect" call again.
        me.connect();
        me.reconnecting = false;
    },
    init: function(arg) {
        var b = this;
        b.error = (typeof arg.error == "undefined") ? function() {} : arg.error;
        b.handlers = (typeof arg.handlers == "undefined") ? {} : arg.handlers;
        b.raw = (typeof arg.raw == "undefined") ? null : arg.raw;
        b.onconnect = (typeof arg.onconnect == "undefined") ? function() {} : arg.onconnect;
        b.auto = (typeof arg.reconnect == "undefined") ? true : arg.reconnect;

        b.connect();
    },
    save: function(file, data, success, fail) {
        invoke({
            m: "POST",
            url: "/fputs",
            data: "path=" + file + "&content=" + encodeURIComponent(data),
            success: function() { success(); },
            fail: function(e) { fail(e); }
        });
    },
    load: function(file, success, fail) {
        invoke({
            m: "GET",
            url: file,
            success: function(d) { success(d); },
            fail: function(e) { fail(e); }
        });
    }
};
</script>
    <script>
var BackupFile = "/device.cfg";
var devices = {
    add: function(a, f) {
        var g;
        if (f.h == 2) {
            g = window.sensorContainer.cloneNode(true);
            g.querySelector("span.device-address").innerHTML = f.a;
            g.querySelector("span.device-value").innerHTML = (typeof f.v === "undefined") ? "-" : f.v
        } else if (f.h == 5) {
            g = window.extsensorContainer.cloneNode(true);
            g.querySelector("span.device-value").innerHTML = (typeof f.v === "undefined") ? "-" : f.v;
        } else if (f.h == 3) {
            g = window.owContainer.cloneNode(true);
            g.querySelector("span.device-address").innerHTML = f.a;
            g.querySelector("span.device-channel").innerHTML = f.n;
            g.querySelector("select.device-pintype").value = f.x;
            g.querySelector("span.device-value").innerHTML = (typeof f.v === "undefined") ? "-" : ((f.v) ? "active" : "inactive")
        } else {
            g = window.pinContainer.cloneNode(true);
            g.querySelector("select.device-pintype").value = f.x;
            g.querySelector("span.device-value").innerHTML = (typeof f.v === "undefined") ? "-" : ((f.v) ? "active" : "inactive")
        }
        g.querySelector("select.slot-select").value = f.i;
        var c = {
            0: "D3",
            1: "D10",
            2: "D4",
            3: "D9",
            4: "D2",
            5: "D1",
            12: "D6",
            13: "D7",
            14: "D5",
            15: "D8",
            16: "D0",
            17: "A0"
        };
        g.querySelector("span.device-pin").innerHTML = (f.p > 0) ? c[f.p] : "NA";
        g.querySelector("select.device-function").value = f.f;
        g.querySelector("div.device-title").innerHTML = "Device " + a;
        g.querySelector("button").onclick = function() {
            device_apply(a)
        };
        g.hardwaretype = f.h;
        g.pinnumber = f.p;
        var b = (f.i < 0) ? "detected-list" : "installed-list";
        var e = document.getElementById(b);
        e.appendChild(g);
        e.appendChild(document.createElement("br"))
    }
};
var installed_list = [];
var available_list = [];

function cmdfrom(b) {
    var a;
    if (b < installed_list.length) {
        a = installed_list[b]
    } else {
        a = available_list[b - installed_list.length]
    }
    var d = document.querySelectorAll("div.device-container")[b];
    var c = {};
    c.i = d.querySelector("select.slot-select").value;
    c.c = 1;
    c.f = d.querySelector("select.device-function").value;
    if (c.f >= 9 && c.f <= 15) {
        c.b = 1
    } else {
        c.b = 0
    }
    c.h = a.h;
    c.p = a.p;
    if (c.h == 2) {
        c.a = a.a
    } else if (c.h == 3) {
        c.a = a.a;
        c.n = a.n;
        c.x = d.querySelector("select.device-pintype").value
    } else if (c.h == 1) {
        c.x = d.querySelector("select.device-pintype").value
    }
    return c
}

function device_apply(a) {
    blockscreen("更新設定中...");
    var b = cmdfrom(a);
    var c = "U" + JSON.stringify(b);
    console.log(c);
    var tout = setTimeout(function() {
        alert("逾時!")
        unblockscreen();
    }, 5000);

    BWF.on("U", function(d) {
        if (tout) clearTimeout(tout);
        unblockscreen();
    });
    BWF.send(c)
}

function backup() {
    if (installed_list.length == 0) {
        alert("沒有己安裝的設備!");
        return
    }
    var c = [];
    for (var a = 0; a < installed_list.length; a++) {
        var f = installed_list[a];
        var e = {
            i: f.i,
            c: f.c,
            b: f.b,
            f: f.f,
            h: f.h,
            p: f.p
        };
        if (f.h == 2) {
            e.a = f.a
        } else {
            e.x = f.x
        }
        c.push(e)
    }
    var b = JSON.stringify(c);
    console.log(b);
    BWF.save(BackupFile, b, function() {
        alert("完成")
    }, function(d) {
        alert("無法儲存:" + d)
    })
}

function restore() {
    blockscreen("回復設定中...");
    BWF.load(BackupFile, function(c) {
        var b = JSON.parse(c);
        var a = 0;
        BWF.on("U", function(d) {
            if (++a >= b.length) {
                BWF.on("U", null);
                unblockscreen();
                return
            }
            BWF.send("U" + JSON.stringify(b[a]))
        });
        BWF.send("U" + JSON.stringify(b[a]))
    }, function(a) {
        alert("無法載入:" + a);
        unblockscreen()
    })
}

function list() {
    blockscreen("取得資訊中...");
    installed_list = [];
    available_list = [];
    document.getElementById("detected-list").innerHTML = "";
    document.getElementById("installed-list").innerHTML = "";
    BWF.send("d{r:1}");
    BWF.send("h{u:-1,v:1}")
}

function erase() {
    if (confirm("清除所有設定？")) BWF.send("E");
}

function listGot() {
    document.getElementById("detected-list").innerHTML = "";
    document.getElementById("installed-list").innerHTML = "";
    var a = 0;
    for (var b = 0; b < installed_list.length; b++) {
        devices.add(a++, installed_list[b])
    }
    for (var b = 0; b < available_list.length; b++) {
        devices.add(a++, available_list[b])
    }
    unblockscreen()
}

function detachNode(query) {
    var d = document.querySelector(query);
    d.parentNode.removeChild(d);
    return d;
}

function init(classic) {
    if (typeof classic == "undefined") classic = false;
    if (!classic) {
        getActiveNavItem();
        Q("#verinfo").innerHTML = "v" + JSVERSION;
    }

    window.sensorContainer = detachNode(".device-container.sensor-device");
    window.pinContainer = detachNode(".device-container.pin-device");
    window.extsensorContainer = detachNode(".device-container.extsensor-device");
    window.owContainer = detachNode(".device-container.ow-device");

    BWF.init({
        error: function(a) {
            //                alert("error communication between server")
        },
        handlers: {
            d: function(a) {
                installed_list = a
            },
            h: function(a) {
                available_list = a;
                listGot()
            }
        }
    })
}

function blockscreen(a) {
    document.getElementById("blockscreencontent").innerHTML = a;
    document.getElementById("blockscreen").style.display = "block"
}

function unblockscreen() {
    document.getElementById("blockscreen").style.display = "none"
};
</script>
</head>
<style>
    button {
        color: #1d5987;
        background: #dfeffc;
        font-weight: bold;
        border-top-right-radius: 5px;
        border-top-left-radius: 5px;
        border-bottom-right-radius: 5px;
        border-bottom-left-radius: 5px
    }
    
    .corner-top {
        border-top-right-radius: 5px;
        border-top-left-radius: 5px
    }
    
    .corner-bottom {
        border-bottom-right-radius: 5px;
        border-bottom-left-radius: 5px
    }
    
    .navbar {
        margin: 0;
        padding: .2em .2em 0;
        border: 1px solid #4297d7;
        background: #5c9ccc;
        color: #fff;
        height: 2em;
        display: block;
        position: relative
    }
    
    .bar-title {
        margin-right: 160px;
        font-weight: bold
    }
    
    .device-container {
        border: 1px solid;
        padding: 5px
    }
    
    .device-setting-container {
        padding: 5px;
        width: 150px;
        float: left;
        color: #555
    }
    
    .device-titleNapply {
        float: left;
        padding: 5px
    }
    
    .setting-name {
        font-weight: bold;
        display: block
    }
    
    .device-detail {
        float: left
    }
    
    .device-title {
        display: block;
        white-space: nowrap;
        float: left;
        clear: both;
        font-size: 1.2em;
        color: #306fa9
    }
    
    #installed-device,
    #detected-device {
        font-weight: bold;
        font-size: 18px;
        padding: .5em
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        padding-top: 100px;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: #000;
        background-color: rgba(0, 0, 0, 0.4)
    }
    
    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%
    }
</style>

<body onload="init(true)">
    <div class="navbar corner-top corner-bottom">
        <span class="bar-title">設備列表</span>
        <button onclick="backup()">備份</button>
        <button onclick="restore()">恢復備份</button>
        <button onclick="erase()">重設EEPROM</button>
        <button onclick="list()">更新列表</button>
    </div>
    <div id="device-list">
        <div id="installed-device">
            己安裝的設備
        </div>
        <div id="installed-list"></div>
        <div id="detected-device">
            偵測到的設備
        </div>
        <div id="detected-list">
        </div>
    </div>
    <div class="device-container extsensor-device">
        <table>
            <tr>
                <td rowspan="2">
                    <div class="device-title"></div>
                    <br>
                    <button>套用</button>
                </td>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">設備編號slot</span>
                        <select class="slot-select">
                                <option value="-1">不指定</option>
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                                <option value="15">15</option>
                            </select>
                    </div>
                </td>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">硬體類型</span>
                        <span class="setting-value device-type">外部感測器</span>
                    </div>
                </td>
                <td>
                    <div class="device-setting-container device-address-container">
                        <span class="setting-name"></span>
                        <span class="setting-value device-address"></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">控制腳位</span>
                        <span class="setting-value device-pin"></span>
                    </div>
                </td>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">數值</span>
                        <span class="setting-value device-value">--</span>
                    </div>
                </td>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">功能</span>
                        <select class="setting-value device-function">
                                <option value="0">無</option>
                                <option value="5">發酵室溫度</option>
                                <option value="6">室溫</option>
                                <option value="9">啤酒溫度</option>
                            </select>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <div class="device-container sensor-device">
        <table>
            <tr>
                <td rowspan="2">
                    <div class="device-title"></div>
                    <br>
                    <button>套用</button>
                </td>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">設備編號slot</span>
                        <select class="slot-select">
                                <option value="-1">不指定</option>
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                                <option value="15">15</option>
                            </select>
                    </div>
                </td>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">硬體類型</span>
                        <span class="setting-value device-type">感測器</span>
                    </div>
                </td>
                <td>
                    <div class="device-setting-container device-address-container">
                        <span class="setting-name">位址</span>
                        <span class="setting-value device-address"></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">控制腳位</span>
                        <span class="setting-value device-pin"></span>
                    </div>
                </td>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">數值</span>
                        <span class="setting-value device-value"></span>
                    </div>
                </td>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">功能</span>
                        <select class="setting-value device-function">
                                    <option value="0">無</option>
                                    <option value="5">發酵室溫度</option>
                                    <option value="6">室溫</option>
                                    <option value="9">啤酒溫度</option>
                                </select>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <div class="device-container pin-device">
        <table>
            <tr>
                <td rowspan="2">
                    <div class="device-title"></div>
                    <br>
                    <button>套用</button>
                </td>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">設備編號slot</span>
                        <select class="slot-select">
                                <option value="-1">不指定</option>
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                                <option value="15">15</option>
                            </select>
                    </div>
                </td>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">硬體類型</span>
                        <span class="setting-value device-type">腳位</span>
                    </div>
                </td>
                <td>
                    <div class="device-setting-container device-pintype-container">
                        <span class="setting-name">腳位類型</span>
                        <select class="setting-value device-pintype">
                                <option value="0">非反相</option>
                                <option value="1">反相</option>
                            </select>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">控制腳位</span>
                        <span class="setting-value device-pin"></span>
                    </div>
                </td>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">數值</span>
                        <span class="setting-value device-value"></span>
                    </div>
                </td>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">功能</span>
                        <select class="setting-value device-function">
                                <option value="0">無</option>
                                <option value="1">發酵室門</option>
                                <option value="2">加熱器</option>
                                <option value="3">冷卻器</option>
                                <option value="4">燈泡</option>
                                <option value="7">風扇</option>
                                <option value="14">Capper</option>
                                <option value="15">PTC Cooler</option>

                            </select>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <div class="device-container ow-device">
        <table>
            <tr>
                <td rowspan="2">
                    <div class="device-title"></div>
                    <br>
                    <button>套用</button>
                </td>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">設備編號slot</span>
                        <select class="slot-select">
                            <option value="-1">不指定</option>
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                        </select>
                    </div>
                </td>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">硬體類型</span>
                        <span class="setting-value device-type">1-wire actuator</span>
                    </div>
                </td>
                <td>
                    <div class="device-setting-container device-address-container">
                        <span class="setting-name">位址</span>
                        <span class="setting-value device-address"></span>
                    </div>
                </td>
                <td>
                    <div class="device-setting-container device-channel-container">
                        <span class="setting-name">Channel</span>
                        <span class="setting-value device-channel"></span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">控制腳位N</span>
                        <span class="setting-value device-pin"></span>
                    </div>
                </td>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">數值</span>
                        <span class="setting-value device-value"></span>
                    </div>
                </td>
                <td>
                    <div class="device-setting-container">
                        <span class="setting-name">功能</span>
                        <select class="setting-value device-function">
                                <option value="0">無</option>
                                <option value="1">發酵室門</option>
                                <option value="2">加熱器</option>
                                <option value="3">冷卻器</option>
                                <option value="4">燈泡</option>
                                <option value="7">風扇</option>
                                <option value="14">Capper</option>
                                <option value="15">PTC Cooler</option>

                        </select>
                    </div>
                </td>
                <td>
                    <div class="device-setting-container device-pintype-container">
                        <span class="setting-name">腳位類型</span>
                        <select class="setting-value device-pintype">
                                <option value="0">非反相</option>
                                <option value="1">反相</option>
                        </select>
                    </div>
                </td>
            </tr>
        </table>
    </div>
    <div id="blockscreen" class="modal">
        <div id="blockscreencontent" class="modal-content">
        </div>
    </div>
</body>

</html>
