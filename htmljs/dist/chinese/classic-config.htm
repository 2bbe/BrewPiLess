<!DOCTYPE html>

<html lang="zh-tw">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    <title>
        BrewPiLess系統組態
    </title>
    <script>
function invoke(arg) {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (xhttp.readyState == 4) {
            if (xhttp.status == 200) {
                arg.success(xhttp.responseText);
            } else {
                xhttp.onerror(xhttp.status);
            }
        }
    };
    xhttp.ontimeout = function() {
            if (typeof arg["timeout"] != "undefined")
                arg.timeout();
            else
                xhttp.onerror(-1);
        },
        xhttp.onerror = function(a) {
            if (typeof arg["fail"] != "undefined")
                arg.fail(a);
        };

    xhttp.open(arg.m, arg.url, true);
    if (typeof arg["data"] != "undefined") {
        xhttp.setRequestHeader("Content-Type", (typeof arg["mime"] != "undefined") ? arg["mime"] : "application/x-www-form-urlencoded");
        xhttp.send(arg.data);
    } else
        xhttp.send();
}

var BWF = {
    BrewProfile: "/brewing.json",
    process: function(msg) {
        if (this.raw != null) {
            this.raw(msg);
            return;
        }
        //console.log("rcv:" + msg);
        eval("m={" + msg + "}");
        //	console.log("json:"+m);
        for (var key in m) {
            if (typeof this.handlers[key] != "undefined") {
                this.handlers[key](m[key]);
            }
        }
    },
    on: function(lb, handler) {
        this.handlers[lb] = handler;
    },
    send: function(data) {
        if (this.ws.readyState == 1) this.ws.send(data);
    },
    reconnecting: false,
    connect: function() {
        var me = this;
        if (typeof WebSocket !== "undefined") {
            var ws = new WebSocket('ws://' + document.location.host + '/ws');
            me.ws = ws;
            ws.onopen = function() {
                console.log("Connected");
                me.onconnect();
            };

            ws.onclose = function() {
                if (me.reconnecting) return;
                console.log("WS close");
                me.error(-2);
                if (me.auto) setTimeout(function() { me.reconnect(); }, 5000);
            };

            /*ws.onerror = function() {
                console.log("ws error");
            };*/

            ws.onmessage = function(e) {
                me.process(e.data);
            };
        } else {
            //console.log("not support WebSocket");
            alert("Error! WebSocket Not Supported!");
        }
    },
    reconnect: function(forced) {
        forced = (typeof forced == "undefined") ? false : true;
        var me = this;
        if (me.reconnecting) return;
        if (!forced && me.ws.readyState == 1) return;
        console.log("reconnect forced:" + forced + " state:" + me.ws.readyState);
        me.reconnecting = true;
        me.ws.close();
        // this might triger onerror, and result in "reconnect" call again.
        me.connect();
        me.reconnecting = false;
    },
    init: function(arg) {
        var b = this;
        b.error = (typeof arg.error == "undefined") ? function() {} : arg.error;
        b.handlers = (typeof arg.handlers == "undefined") ? {} : arg.handlers;
        b.raw = (typeof arg.raw == "undefined") ? null : arg.raw;
        b.onconnect = (typeof arg.onconnect == "undefined") ? function() {} : arg.onconnect;
        b.auto = (typeof arg.reconnect == "undefined") ? true : arg.reconnect;

        b.connect();
    },
    save: function(file, data, success, fail) {
        invoke({
            m: "POST",
            url: "/fputs",
            data: "path=" + file + "&content=" + encodeURIComponent(data),
            success: function() { success(); },
            fail: function(e) { fail(e); }
        });
    },
    load: function(file, success, fail) {
        invoke({
            m: "GET",
            url: file,
            success: function(d) { success(d); },
            fail: function(e) { fail(e); }
        });
    }
};
</script>
    <script>
function s_ajax(b) {
    var c = new XMLHttpRequest();
    c.onreadystatechange = function() {
        if (c.readyState == 4) {
            if (c.status == 200) {
                b.success(c.responseText)
            } else {
                c.onerror(c.status)
            }
        }
    };
    c.ontimeout = function() {
        if (typeof b["timeout"] != "undefined") b.timeout();
        else c.onerror(-1)
    }, c.onerror = function(a) {
        if (typeof b["fail"] != "undefined") b.fail(a)
    };
    c.open(b.m, b.url, true);
    if (typeof b["data"] != "undefined") {
        c.setRequestHeader("Content-Type", (typeof b["mime"] != "undefined") ? b["mime"] : "application/x-www-form-urlencoded");
        c.send(b.data)
    } else c.send()
}

var Q = function(d) {
    return document.querySelector(d);
};
</script>
    <script>
function formatIP(ip) {
    if (ip == "0.0.0.0") return "";
    return ip;
}


function loadSetting() {
    s_ajax({
        url: "config?cfg=1",
        m: "GET",
        success: function(data) {
            var j = JSON.parse(data);
            window.oridata = j;
            Object.keys(j).map(function(key) {
                var div = Q("input[name=" + key + "]");
                if (div) {
                    if (div.classList.contains("iptype")) {
                        div.value = formatIP(j[key]);
                    } else if (div.type == "checkbox") div.checked = (j[key] != 0);
                    else div.value = j[key];
                } else {
                    // wifi mode
                    div = Q("select[name=" + key + "]");
                    if (div) {
                        div.value = j[key];
                    }
                }
            });
        },
        fail: function(d) {
            alert("無法取得設定值。:" + d);
        }
    });
}

function waitrestart() {
    Q("#waitprompt").style.display = "block";
    Q("#inputform").style.display = "none";
    setTimeout(function() {
        window.location.reload();
    }, 15000);
}

function save() {
    var ins = document.querySelectorAll("#sysconfig input");
    var data = "";
    //(new Uint32Array([-1]))[0]
    var json = {};
    var reboot = false;
    Object.keys(ins).map(function(key, i) {
        if (ins[i].type != "submit") {
            if (ins[i].name && ins[i].name != "") {
                var val;
                if (ins[i].type == "checkbox") val = (ins[i].checked ? 1 : 0);
                else val = ins[i].value.trim();
                json[ins[i].name] = val;
                if (window.oridata[ins[i].name] != val && !ins[i].classList.contains("nb"))
                    reboot = true;
            }
        }
    });
    var div = Q("select[name=wifi]");
    json["wifi"] = div.value;
    console.log(JSON.stringify(json));
    var url = "config" + (reboot ? "" : "?nb");
    s_ajax({
        url: url,
        data: "data=" + encodeURIComponent(JSON.stringify(json)),
        m: "POST",
        success: function(data) {
            if (reboot) waitrestart();
        },
        fail: function(d) {
            alert("儲存失敗:" + d);
        }
    });
}

function loadMqttSetting() {
    s_ajax({
        url: "mqtt",
        m: "GET",
        success: function(data) {
            var j = JSON.parse(data);
            Object.keys(j).map(function(key) {
                var name = "mqtt_" + key;
                var div = Q("input[name=" + name + "]");
                if (div) {
                    if (div.type == "checkbox") div.checked = (j[key] != 0);
                    else div.value = j[key];
                }
            });
        },
        fail: function(d) {
            alert("無法取得設定值。:" + d);
        }
    });
}

function saveMqtt() {
    var ins = document.querySelectorAll("#mqtt input");
    var json = {};
    Object.keys(ins).map(function(key, i) {
        if (ins[i].type != "submit") {
            if (ins[i].name && ins[i].name != "") {
                var val;
                if (ins[i].type == "checkbox") val = (ins[i].checked ? 1 : 0);
                else val = ins[i].value.trim();
                json[ins[i].name.split("_")[1]] = val;
            }
        }
    });
    console.log(JSON.stringify(json));
    s_ajax({
        url: "mqtt",
        data: "data=" + encodeURIComponent(JSON.stringify(json)),
        m: "POST",
        success: function(data) {
            alert("done");
        },
        fail: function(d) {
            alert("儲存失敗:" + d);
        }
    });
}

function load() {
    if (Q("#verinfo")) {
        Q("#verinfo").innerHTML = "v" + JSVERSION;
        getActiveNavItem();
    }
    loadSetting();
loadMqttSetting();
    Net.init();

    Q("#submitsave").onclick = function(e) {
        e.preventDefault();
        save();
        return false;
    };

    Q("#submitsavemqtt").onclick = function(e) {
        e.preventDefault();
        saveMqtt();
        return false;
    };

}


function validIP(t) {
    var digits = t.split(".");
    var value = 0;
    if (digits.length != 4) return false;
    for (var i = 0; i < 4; i++) {
        var di = parseInt(digits[i]);
        value = (value << 8) + di;
        if (di > 255) {
            return false;
        }
    }
    return value;
}

function modechange(sel) {}

var Net = {
    select: function(l) {
        document.getElementById('ssid').value = l.innerText || l.textContent;
        document.getElementById('nwpass').focus();
        return false;
    },
    init: function() {
        this.litem = Q(".nwlist");
        this.litem.parentNode.removeChild(this.litem);
        this.setupEvent();
        this.hide();
    },
    nwevent: function(data) {
        var me = this;
        //console.log("ws:" + data);
        if (typeof data["list"] != "undefined") {
            me.list(data.list);
        } else if (typeof data["ssid"] != "undefined") {
            if (data.ssid != "") {
                Q("#connnected-ssid").innerHTML = data.ssid;
            }
            if (typeof data["ip"] != "undefined")
                if (data.ip != "") {
                    Q("#sta-ip").innerHTML = data.ip;

                }
        }
    },
    rssi: function(x) {
        return (x > 0) ? "?" : Math.min(Math.max(2 * (x + 100), 0), 100);
    },
    list: function(nwlist) {
        var nws = Q("#networks");
        nws.innerHTML = "";
        for (var i = 0; i < nwlist.length; i++) {
            var nl = this.litem.cloneNode(true);
            nl.getElementsByTagName("a")[0].innerHTML = nwlist[i].ssid;
            var signal = nl.getElementsByTagName("span")[0];
            signal.innerHTML = "" + this.rssi(nwlist[i].rssi) + "%";
            if (nwlist[i].enc) signal.className = signal.className + " l";
            nws.appendChild(nl);
        }
    },
    setupEvent: function() {
        var b = this;

        BWF.init({
            handlers: {
                W: function(ev) {
                    b.nwevent(ev);
                }
            }
        });
    },
    scan: function() {
        var lists = Q("#networks");
        lists.innerHTML = "Scanning...";

        s_ajax({
            m: "GET",
            url: "/wifiscan",
            success: function() {}
        });
        return false;
    },
    save: function() {
        var data = "nw=" + encodeURIComponent(Q("#ssid").value);
        if (Q("#nwpass").value != "") data = data + "&pass=" + encodeURIComponent(Q("#nwpass").value);
        var ip = validIP(Q("#staticip").value);
        var gw = validIP(Q("#gateway").value);
        var nm = validIP(Q("#netmask").value);
        if (ip && gw && nm) {
            data = data + "&ip=" + Q("#staticip").value.trim() +
                "&gw=" + Q("#gateway").value.trim() + "&nm=" + Q("#netmask").value.trim();
        }
        s_ajax({
            m: "POST",
            url: "/wificon",
            data: data,
            success: function() {}
        });
        this.hide();
        return false;
    },
    show: function() {
        Q("#networkselection").style.display = "block";
    },
    hide: function() {
        Q("#networkselection").style.display = "none";
    }
};

</script>
    <style>
        #waitprompt {
            display: none;
        }
        
        .modal {
            display: none;
            -webkit-box-align: center;
            -ms-flex-align: center;
            align-items: center;
            -webkit-box-pack: center;
            -ms-flex-pack: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 1000;
            -webkit-transition: all .5s cubic-bezier(.23, 1, .32, 1);
            transition: all .5s cubic-bezier(.23, 1, .32, 1);
            -webkit-transition-delay: 0s;
            transition-delay: 0s;
            background: rgba(0, 0, 0, .3)
        }
        
        .modal-content {
            position: relative;
            padding: 2.4rem;
            background: #fff;
            background-clip: padding-box;
            -webkit-box-shadow: 0 12px 15px 0 rgba(0, 0, 0, .25);
            box-shadow: 0 12px 15px 0 rgba(0, 0, 0, .25);
            -webkit-transition: all .25s cubic-bezier(.23, 1, .32, 1);
            transition: all .25s cubic-bezier(.23, 1, .32, 1);
            max-width: 600px;
            padding: 2rem
        }
        
        .modal-header {
            font-weight: bold;
            font-size: 1.2em;
        }
        /* for network selection */
        
        .center {
            text-align: center;
        }
        
        div,
        input {
            padding: 5px;
            font-size: 1em;
        }
        
        .modal input {
            width: 95%;
        }
        
        body {
            text-align: center;
            font-family: verdana;
        }
        
        .modal button {
            border: 0;
            border-radius: 0.3rem;
            background-color: #1fa3ec;
            color: #fff;
            line-height: 2.4rem;
            font-size: 1.2rem;
            width: 96%;
            margin: 4px;
        }
        
        .scannednetwork {
            float: right;
            width: 64px;
            text-align: right;
        }
        
        .l {
            background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAALVBMVEX///8EBwfBwsLw8PAzNjaCg4NTVVUjJiZDRUUUFxdiZGSho6OSk5Pg4eFydHTCjaf3AAAAZElEQVQ4je2NSw7AIAhEBamKn97/uMXEGBvozkWb9C2Zx4xzWykBhFAeYp9gkLyZE0zIMno9n4g19hmdY39scwqVkOXaxph0ZCXQcqxSpgQpONa59wkRDOL93eAXvimwlbPbwwVAegLS1HGfZAAAAABJRU5ErkJggg==") no-repeat left center;
            background-size: 1em;
        }
        
        #networkselection {
            text-align: left;
            display: inline-block;
            min-width: 260px;
        }
    </style>
</head>

<body onload="load();">
    <div id="waitprompt">
        設定已儲存，等待重新啓動中。請注意：如果有更改主機名稱，自動載入不會成功。
    </div>
    <div id="inputform">
        <div id="sysconfig">
            <form action="#" action="post">
                <table>
                    <tr>
                        <td>
                            LCD自動關閉
                        </td>
                        <td><input name="aoff" type="text" size="5" maxlength="5" class="nb">
                            秒
                        </td>
                    </tr>

                    <tr>
                        <td>
                            網頁名稱
                        </td>
                        <td><input name="title" type="text" size="12" maxlength="24"></td>
                    </tr>
                    <tr>
                        <td>
                            網路主機名稱
                        </td>
                        <td><input name="name" type="text" size="12" maxlength="16"></td>
                    </tr>
                    <tr>
                        <td>
                            HTTP Port
                        </td>
                        <td><input name="port" type="text" size="5" maxlength="5"></td>
                    </tr>
                    <tr>
                        <td>
                            使用者名稱
                        </td>
                        <td><input name="user" type="text" size="12" maxlength="16" class="nb"></td>
                    </tr>
                    <tr>
                        <td>
                            密碼
                        </td>
                        <td><input name="pass" type="password" size="12" maxlength="16" class="nb"></td>
                    </tr>
                    <tr>
                        <td>
                            全部頁面要求密碼
                        </td>
                        <td><input type="checkbox" name="protect"></td>
                    </tr>
                    <tr>
                        <td>
                            網路模式
                        </td>
                        <td><select name="wifi" class="nb" onchange="modechange(this);">
                        <option value="1">Station</option>
                        <option value="2">AP</option>
                        <option value="3">Station + AP</option>
                    </select></td>
                    </tr>
                    <tr class="staconfig">
                        <td class>
                            網路設定
                        </td>
                        <td><button id="connnected-ssid" onclick="Net.show();return false;">...</button> </td>
                    </tr>
                    <tr class="staconfig">
                        <td>
                            IP
                        </td>
                        <td><span id="sta-ip"></span> </td>
                    </tr>

                    <tr>
                        <td>
                            儲存變更
                        </td>
                        <td><input type="submit" id="submitsave" name="submit">
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>

    <div id="networkselection" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                選擇網路
            </div>
            <div id="networks">
                <div class="nwlist">
                    <a href="#" onclick="Net.select(this)" class="ssid">N</a>&nbsp;<span class="scannednetwork"></span></div>
            </div>
            <div class="center">
                <a href="#" onclick="return Net.scan();">
                    搜尋可用網路
                </a>
            </div>
            <form method="get" action="#">
                <input id="ssid" name="ssid" length="32" placeholder="SSID"><br>
                <input id="nwpass" name="nwpass" length="64" type="password" placeholder="password"><br><br>
                <input id="staticip" name="ip" length="1" placeholder="固定IP" class="nb iptype"><br>
                <input id="gateway" name="gw" length="1" placeholder="Gateway" class="nb iptype"><br>
                <input id="netmask" name="mask" length="1" placeholder="Netmask" class="nb iptype"><br><br>
                <button type="button" onclick="return Net.save()">儲存變更</button>
                <button onclick="Net.hide();return false;">取消</button>
            </form>
        </div>
    </div>

</body>

</html>